@using BlazorApp1.Data

@code
{
	List<Checker> blackCheckers = new List<Checker>();
	List<Checker> whiteCheckers = new List<Checker>();


	protected override void OnInitialized()
	{
		for (int i = 0; i < 3; i++)
		{
			for (int j = (i + 1) % 2; j < 8; j += 2)
			{

				blackCheckers.Add(new Checker
					{
						Color = "black",
						Column = j,
						Row = i,
						Direction = CheckersDirection.Down
					});
			}
		}
		for (int i = 5; i < 8; i++)
		{
			for (int j = (i + 1) % 2; j < 8; j += 2)
			{

				whiteCheckers.Add(new Checker
					{
						Color = "white",
						Column = j,
						Row = i,
						Direction = CheckersDirection.Up
					});
			}
		}
	}

	Checker activeChecker = null;
	List<(int row, int column)> cellsPossible = new();
	void EvalueCheckerSpots()
	{
		cellsPossible.Clear();
		if (activeChecker != null)
		{
			List<int> rowsPossible = new List<int>();
			if (activeChecker.Direction == CheckersDirection.Down ||
				activeChecker.Direction == CheckersDirection.Both)
			{
				rowsPossible.Add(activeChecker.Row + 1);
			}
			if (activeChecker.Direction == CheckersDirection.Up ||
						activeChecker.Direction == CheckersDirection.Both)
			{
				rowsPossible.Add(activeChecker.Row - 1);
			}
			foreach (var row in rowsPossible)
			{
				EvaluateSpot(row, activeChecker.Column - 1);
				EvaluateSpot(row, activeChecker.Column + 1);

			};
		}
	}
	void EvaluateSpot(int row, int column, bool firstTime = true)
	{
		var blackChecker = blackCheckers.FirstOrDefault(
			n => n.Column == column && n.Row == row);

		var whiteChecker = whiteCheckers.FirstOrDefault(
			n => n.Column == column && n.Row == row);


		if (blackChecker == null && whiteChecker == null)
		{
			cellsPossible.Add((row, column));
		}
		else if (firstTime)
		{
			// can i jump this checker?
			if ((whiteTurn && blackChecker != null) ||
						(!whiteTurn && whiteChecker != null))
			{
				int columnDifference = column - activeChecker.Column;
				int rowDifference = row - activeChecker.Row;
				EvaluateSpot(row + rowDifference, column + columnDifference, false);
			}
		}
	}
	int blackScore = 0;
	int whiteScore = 0;
	void MoveChecker(int row, int column)
	{
		bool canMoveHere = cellsPossible.Contains((row, column));
		if (!canMoveHere)
			return;
		if (Math.Abs(activeChecker.Column - column) == 2)
		{
			// we jumped somthing
			int jumpedColumn = (activeChecker.Column + column) / 2;
			int jumpedRow = (activeChecker.Row + row) / 2;
			var blackChecker = blackCheckers.FirstOrDefault(
				n => n.Row == jumpedRow && n.Column == jumpedColumn);
			if (blackChecker != null)
				blackCheckers.Remove(blackChecker);
				whiteScore++;

			var whiteChecker = whiteCheckers.FirstOrDefault(
				n => n.Row == jumpedRow && n.Column == jumpedColumn);
			if (whiteChecker != null)
				whiteCheckers.Remove(whiteChecker);
				blackScore++;
		}
		activeChecker.Column = column;
		activeChecker.Row = row;

		if (activeChecker.Row == 0 && activeChecker.Color == "white")
		{
			activeChecker.Direction = CheckersDirection.Both;
		}
		if (activeChecker.Row == 7 && activeChecker.Color == "black")
		{
			activeChecker.Direction = CheckersDirection.Both;
		}

		activeChecker = null;
		whiteTurn = !whiteTurn;
		EvalueCheckerSpots();
	}
	void CheckerClicked(Checker checker)
	{
		if (whiteTurn && checker.Color == "black")
			return;
		if (!whiteTurn && checker.Color == "white")
			return;
		activeChecker = checker;
		EvalueCheckerSpots();
	}
	bool whiteTurn = true;

}

<div class="d-flex justify-content-center">


	<div>
		<div class="black d-flex checker"></div>
		<h3 class="d-flex justify-content-center">Checkersboard</h3>
		<div class="white d-flex ckecker"></div>

		@for (int i = 0; i < 8; i++)
		{
			int localI = i;
			<div class="row">
				@for (int j = 0; j < 8; j++)
				{
					int localJ = j;
					var checker = blackCheckers.FirstOrDefault(n => n.Column == j && n.Row == i);
					if (checker == null)
					{
						checker = whiteCheckers.FirstOrDefault(n => n.Column == j && n.Row == i);
					}
					bool canMoveHere = cellsPossible.Contains((i, j));

					<div @onclick=" () => MoveChecker(localI, localJ)" class="cell @(canMoveHere ? "active" : "")">
						@if (checker != null)
						{
							<div @onclick="() => CheckerClicked(checker)"
					         class="checker @checker.Color @(checker == activeChecker ? "active" : "")">
								<span>@(checker.Direction == CheckersDirection.Both ? "K" : "")</span>
							</div>
						}
					</div>
				}
			</div>

		}


	</div>

</div>






